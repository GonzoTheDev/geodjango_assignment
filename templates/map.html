{% extends "base.html" %}
{% block title %}Map{% endblock %}
{% block content %}

{% if user.is_authenticated %}
    {% load leaflet_tags %}
    {% leaflet_js %}
    {% leaflet_css %}
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand px-2"><i class="fa-solid fa-fish" style="color: #00aacc;"></i> Ireland Fishing Guide</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'home' %}">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'map' %}">Fishing Marks</a>
                </li>
                <li class="nav-item">
                    <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">
                        {% csrf_token %}
                    </form>
                    <a href="javascript:void(0);" class="nav-link" onclick="document.getElementById('logout-form').submit();">Log Out</a>
                </li>                    
            </ul>
        </div>
    </nav>

    <!-- Content -->
    <div class="container data-vis">
        <div class="row">
            <!-- Map -->
            <div class="col-md-12">
                <div class="map">
                    {% leaflet_map "fishing_map" callback="window.map_init" %}
                </div>
            </div>
            <div class="col-md-12">
                <div class="mt-3 mb-3">
                    Nearest fishing mark - <b id="address-location"></b>
                </div>
            </div>
            <!-- Chatbot -->
            <div class="col-md-12">
                <div class="alert">
                    <div id="chatbox">
                        <!-- Chat messages will appear here -->
                        <div id="chats"></div>
                        <div id="loadingSpinner" style="display: none;">
                            <img class="loading_gif text-center" src="/static/assets/images/loading2.gif" alt="Loading..."/>
                        </div>
                    </div>
                    <input type="text" id="userInput" placeholder="Ask the fishing assistant...">
                    <button class="sendBtn" onclick="sendMessage()">Send</button>
                </div>
            </div>
            <!-- Favourite Fishing Mark Info -->
            <div class="col-md-6">
                <div class="alert alert-primary">
                    <h4 class="alert-heading text-center">Your current favourite fishing mark is: </h4><p><span id="favouriteLocation">{{ favourite_mark }}</span></p>
                    <p>favourite since: <span id="lastUpdated">{{ last_updated }}</span></p>
                </div>
            </div>
            <!-- Location Info -->
            <div class="col-md-6">
                <div class="alert alert-info" id="locationAlert">
                    <h4 class="alert-heading">Your Location</h4>
                    <h5>
                        Lat: <span id="latitude"></span>
                        Lon: <span id="longitude" class="lon-span"></span>
                    </h5>
                </div>
                <!-- Update Favourite Fishing Mark -->
                <div class="mt-3 mb-3">
                    <select class="form-control" id="locationSelect">
                        <option value="" selected disabled>Select a fishing mark: </option>
                        {% for fishingmark in fishingmarks %}
                            <option value="{{ fishingmark.latitude }},{{ fishingmark.longitude }}" data-description="{{ fishingmark.description }}">{{ fishingmark.description }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-info updatedb" onclick="update_db()">Update Favourite Fishing Mark</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script>

    // Define global variables
    var map; 
    var favoriteMarkDescription = "{{ favourite_mark }}";
    var currentFavoriteMarker = null; 
    var allMarkers = {};

    // Function to convert degrees to radians
    function toRadians(degrees) {
        return degrees * (Math.PI / 180);
    }

    // Function to calculate distance between two points
    function calculateDistance(lat1, lon1, lat2, lon2) {
        var R = 6371; // radius of the earth in km
        var dLat = toRadians(lat2 - lat1);
        var dLon = toRadians(lon2 - lon1);
        var a =
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c; // distance in km
        return d;
    }

    // Function to initialize the map
    function map_init(mapInstance, options) {

        // Store the map instance in the global variable
        map = mapInstance;

        if ("geolocation" in navigator) {

            // Initialize local variables
            var closestFishingmark;
            var shortestDistance;

            // Get the user's location
            navigator.geolocation.getCurrentPosition(function(position) {
                var userLatitude = position.coords.latitude;
                var userLongitude = position.coords.longitude;

                // define a custom icon for the user's location marker
                var userLocationIcon = L.divIcon({
                    className: 'custom-icon',
                    html: '<i class="fa-solid fa-person" style="font-size: 22px; color: #540198;"></i>',
                });

                // add the user's location marker to the map
                var userLocationMarker = L.marker([userLatitude, userLongitude], { icon: userLocationIcon }).addTo(map);
                userLocationMarker.bindPopup("You are here!!");
                
                // set the view of the map to the user's location and zoom to level 8
                map.setView([userLatitude, userLongitude], 8);

                // display the user's location
                $("#longitude").text(userLongitude);
                $("#latitude").text(userLatitude);

                // iterate over fishing marks and calculate distance from each fishing mark to the user's location
                {% for fishingmark in fishingmarks %}

                    // Define local variables
                    var fishingmark_latitude = {{ fishingmark.latitude }};
                    var fishingmark_longitude = {{ fishingmark.longitude }};
                    var fishingmark_description = "{{ fishingmark.description }}";
                    var distance = calculateDistance(userLatitude, userLongitude, fishingmark_latitude, fishingmark_longitude);

                    // Check if this fishing mark is the closest
                    if (!shortestDistance || distance < shortestDistance) {
                        shortestDistance = distance;
                        closestFishingmark = fishingmark_description;
                    }

                    // Check if this fishing mark is the favorite
                    var isFavorite = fishingmark_description === favoriteMarkDescription;

                    // Define icon based on whether it's the favorite
                    var fishingmark_icon = L.divIcon({
                        className: 'custom-fishingmark-icon',
                        html: isFavorite ? 
                            '<i class="fa-solid fa-star" style="font-size: 22px; color: #540198"></i>' : // Favorite mark icon
                            '<i class="fa-solid fa-location-dot" style="font-size: 22px; color: #00946f"></i>', // Normal mark icon
                    });

                    // Add the fishing mark marker to the map
                    var fishingmarkMarker = L.marker([fishingmark_latitude, fishingmark_longitude], { icon: fishingmark_icon }).addTo(map);
                    fishingmarkMarker.bindPopup(fishingmark_description);

                    // Store the marker in the global allMarkers object
                    allMarkers[fishingmark_description] = fishingmarkMarker;

                     // After creating the favorite marker in the loop, set the global variable
                     if (isFavorite) {
                        currentFavoriteMarker = fishingmarkMarker;
                    }

                {% endfor %}

                // display the closest fishing mark
                $("#address-location").text(closestFishingmark);
            });
        } else {
            alert("No geolocation supported on this browser!!");
        }
    }

    // Function to get the value of a cookie
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Function to update the database with the new favorite fishing mark
    function update_db() {

        // Initialize local variables
        const crsf_token = getCookie('csrftoken');
        var HOST = location.protocol + "//" + location.host;
        var locationAlert = $("#locationAlert");
        var selectedLocation = $("#locationSelect option:selected");
        var locString = selectedLocation.val();
        var description = selectedLocation.data("description");

        // Function to format the current timestamp
        function formatCurrentTimestamp() {
            var now = new Date();
            var months = ["Jan.", "Feb.", "Mar.", "Apr.", "May", "Jun.",
                        "Jul.", "Aug.", "Sep.", "Oct.", "Nov.", "Dec."];
            var month = months[now.getMonth()];
            var day = now.getDate();
            var year = now.getFullYear();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var ampm = hours >= 12 ? 'p.m.' : 'a.m.';
            hours = hours % 12;
            hours = hours ? hours : 12;
            minutes = minutes < 10 ? '0' + minutes : minutes;
            var strTime = hours + ':' + minutes + ' ' + ampm;

            return month + " " + day + ", " + year + ", " + strTime;

        }

        // Get the current timestamp
        var formattedTimestamp = formatCurrentTimestamp();

        // Check if a location was selected
        if (!locString) {
            locationAlert.removeClass("alert-success").addClass("alert-danger").text("Please select a location.").show();
            return;
        }

        // Send the request to the Django backend
        $.ajax({
            type: "POST",
            headers: {
                'X-CSRFToken': crsf_token
            },
            url: HOST + "/updatedb/",
            data: {
                point: locString,
                description: description
            }
        }).done(function (data, status, xhr) {

            // Update the alert content
            locationAlert.removeClass("alert-danger").addClass("alert-success").html("Your favourite fishing mark is now <b>" + description + "</b><br>" + "Lon, Lat: " + locString).show();
            
            // Update the alert content
            $("#longitude").text(data["lon"]);
            $("#latitude").text(data["lat"]);
            $("#favouriteLocation").text(description);
            $("#lastUpdated").text(formattedTimestamp);
        
            // Extract latitude and longitude from the location string
            var [lat, lon] = locString.split(',').map(Number);

            // Update the map with the new favorite fishing mark
            updateFavoriteMarkOnMap(lat, lon, description);

        }).fail(function (xhr, status, error) {

            // Update the alert content
            console.log(error);
            locationAlert.removeClass("alert-success").addClass("alert-danger").text("Failed to update location: " + error);

        }).always(function () {
            locationAlert.show();
        });
    }

    // Function to update the favorite mark on the map
    function updateFavoriteMarkOnMap(lat, lon, newFavoriteDescription) {

        // First, update the icon of the old favorite marker
        if (currentFavoriteMarker && favoriteMarkDescription in allMarkers) {
            var regularIcon = L.divIcon({
                className: 'custom-location-icon',
                html: '<i class="fa-solid fa-location-dot" style="font-size: 22px; color: #00946f"></i>',
            });
            allMarkers[favoriteMarkDescription].setIcon(regularIcon);
        }

        // Then, update the global favorite mark description
        favoriteMarkDescription = newFavoriteDescription;

        // Now, update or add the marker for the new favorite fishing mark
        var favoriteIcon = L.divIcon({
            className: 'custom-favorite-icon',
            html: '<i class="fa-solid fa-star" style="font-size: 22px; color: #540198;"></i>',
        });

        // Check if a marker exists
        if (newFavoriteDescription in allMarkers) {

            // Set the icon to favourite icon
            allMarkers[newFavoriteDescription].setIcon(favoriteIcon);

            // Update the global variable
            currentFavoriteMarker = allMarkers[newFavoriteDescription];

        } else {

            // Create a new marker and add it to the map
            currentFavoriteMarker = L.marker([lat, lon], {icon: favoriteIcon}).addTo(map)
                .bindPopup(newFavoriteDescription);

            // Update the global variable
            allMarkers[newFavoriteDescription] = currentFavoriteMarker;

        }
    }


    // Function to send a message to the chatbot
    function sendMessage() {

        // Initialize local variables
        var inputField = document.getElementById("userInput");
        var message = inputField.value;
        document.getElementById("chats").innerHTML += "<p><b>You: </b>" + message + "</p>";
        document.getElementById("loadingSpinner").style.display = 'block';
        var userLat = document.getElementById("latitude").innerHTML;
        var userLon = document.getElementById("longitude").innerHTML;
        var location = userLat + "," + userLon;
        var chats = document.getElementById("chatbox");

        // Send the message to the Django backend that handles chatbot requests
        fetch(`/chatbot/?message=${encodeURIComponent(message)}&location=${encodeURIComponent(location)}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("loadingSpinner").style.display = 'none';
                document.getElementById("chats").innerHTML += "<p class='assistant'><b>Fishing Assistant: </b>" + data.response + "</p>";
            });
        
        // Scroll to the bottom of the chatbox conversation
        chats.scrollTop = chatBox.scrollHeight;

        // Clear the input field
        inputField.value = ""; 
        
    }

    // Function to send a message when the user presses the enter key
    document.getElementById("userInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            // Prevent the default action to avoid form submission
            event.preventDefault(); 
            sendMessage();
        }
    });
    </script>

{% else %}
<div class="container mt-5">
    <div class="alert alert-warning" role="alert">
        You are not logged in
    </div>
    <a href="{% url 'login' %}" class="btn btn-success">Log In</a>
</div>
{% endif %}
{% endblock %}
